<html>
    <head>
        <title>Purple</title>
        <link href='//fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
        <link id='mainStyleSheet' href='css/main.css' rel='stylesheet' type='text/css' />
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    </head>
    <body>
        <span id="config" data-base-url=""></span>

        <div id="last-updated" style="width: 100%; text-align: center;"></div>

        <h2>Couriers</h2>

        <table id="couriers">
            <thead>
                <tr>
                    <td>Connected</td>
                    <td>Name</td>
                    <td>Busy?</td>
                    <td>On time %</td>
                    <td>Zones</td>
                    <td>Location</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="connected"></td>
                    <td class="name"></td>
                    <td class="busy"></td>
                    <td class="lateness"></td>
                    <td class="zones"></td>
                    <td class="location">
                        <a href="#" target="_blank"></a>
                    </td>
                </tr>
            </tbody>
        </table>

        <h2>Orders <span class="show-all" data-show-id="orders">[show all]</span></h2>
        
        <table id="orders" class="hide-extra">
            <thead>
                <tr>
                    <td>Status</td>
                    <td>Courier</td>
                    <td width="98">Order Placed</td>
                    <td width="98">Deadline</td>
                    <td>Customer</td>
                    <td>Street</td>
                    <td>Gallons</td>
                    <td>Octane</td>
                    <td>Plate #</td>
                    <td>Coupon</td>
                    <td>Total Price</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="status"></td>
                    <td class="courier_name"></td>
                    <td class="target_time_start"></td>
                    <td class="target_time_end"></td>
                    <td class="customer_name"></td>
                    <td class="address_street">
                        <a href="#" target="_blank"></a>
                    </td>
                    <td class="gallons"></td>
                    <td class="octane"></td>
                    <td class="license_plate"></td>
                    <td class="coupon_code"></td>
                    <td class="total_price"></td>
                </tr>
            </tbody>
        </table>
        
        <h2>Users <span class="count" id="users-count"></span> <span class="show-all" data-show-id="users">[show all]</span> <span id="send-push-to-active-users" class="fake-link">[send push notification to all active users]</span> <span id="send-push-to-selected-users" class="fake-link">[send push to selected users]</span></h2>
        
        <table id="users" class="hide-extra">
            <thead>
                <tr>
                    <td>Name</td>
                    <td>Email</td>
                    <td>Phone</td>
                    <td>Card?</td>
                    <td>Push?</td>
                    <td>OS</td>
                    <td>Version</td>
                    <td>Joined</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="name"></td>
                    <td class="email"></td>
                    <td class="phone_number"></td>
                    <td class="has_added_card"></td>
                    <td class="push_set_up"></td>
                    <td class="os"></td>
                    <td class="app_version"></td>
                    <td class="timestamp_created"></td>
                </tr>
            </tbody>
        </table>

        <h2>Coupons <span class="show-all" data-show-id="coupons">[show all]</span></h2>
        
        <table id="coupons" class="hide-extra">
            <thead>
                <tr>
                    <td>Code</td>
                    <td>Value</td>
                    <td>Expiration</td>
                    <td># of Users</td>
                    <td>For First Order Only?</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="code"></td>
                    <td class="value"></td>
                    <td class="expiration_time"></td>
                    <td class="times_used"></td>
                    <td class="only_for_first_orders"></td>
                </tr>
            </tbody>
        </table>
        
        <div style="margin-top: 75px;">
            <form id="configForm">
                <h3>Gas Price Per Gallon</h3>
                87 Octane (in cents) <input type="text" id="gasPriceDollars87" value="" />
                <br />
                91 Octane (in cents) <input type="text" id="gasPriceDollars91" value="" />
                
                <br /><br /><input type="submit" id="configFormSubmit" name="configFormSubmit" value="Save Changes" />
            </form>
            <div id="successMessage" style="display: none">
                Changed successfully.
            </div>
        </div>

        <div style="text-align: center; padding-bottom: 20px;">
            <a href="javascript:window.location+='/data-csv';this.onclick=function(){return false;}">Download data.csv</a>
        </div>
        
        <script>
         $("#configForm").submit(function(e){
             e.preventDefault();
             var price87 = $("#gasPriceDollars87").val();
             var price91 = $("#gasPriceDollars91").val();
             var priceInCents87 = parseInt(price87.replace('$','').replace('.',''));
             var priceInCents91 = parseInt(price91.replace('$','').replace('.',''));
             $.ajax({
                 type: "POST",
                 url: $("#config").data("base-url") + "dashboard/change-gas-price",
                 data: JSON.stringify(
                     {
                         "gas-price-87": priceInCents87,
                         "gas-price-91": priceInCents91
                     }
                 ),
                 dataType: "json",
                 contentType: 'application/json',
                 success: function(response) {
                     if (response.success === true) {
                         $("#configForm").fadeOut(400, function(){
                             $("#successMessage").fadeIn(400);
                         });
                     }
                 }
             });
         });

         $(document).ready(function(){

             $('.show-all').click(function(){
                 var table = $("#" + $(this).data('show-id'));
                 if (table.hasClass('showing-all')) {
                     table.removeClass('showing-all');
                     $(this).html('[show all]');
                 } else {
                     table.addClass('showing-all');
                     $(this).html('[hide after 7]');
                 }
             });

             $('#send-push-to-active-users').click(function(){
                 var message = prompt("Push notification message to send to all active users:");
                 if (!message || message == null || message == "") {
                     return false;
                 }
                 if (confirm("!!! Are you sure you want to send this message to all active users?: " + message)) {
                     $.ajax({
                         type: "POST",
                         url: $("#config").data("base-url") + "dashboard/send-push-to-all-active-users",
                         data: JSON.stringify(
                             {
                                 "message": message
                             }
                         ),
                         dataType: "json",
                         contentType: 'application/json',
                         success: function(response) {
                             alert('Sent!');
                         },
                         failure: function(response) {
                             alert('Something went wrong. Push notifications may or may not have been sent. Wait until sure before trying again.');
                         }
                     });
                 }
             });

             $('#send-push-to-selected-users').click(function(){
                 var users = new Array();
                 $('.send-push-to:checked').each(function(){
                     users.push($(this).val());
                 });

                 if (users.length === 0) {
                     alert('No users selected.');
                     return false;
                 }

                 var message = prompt("Push notification message to send to selected users (" + users.length + "):");
                 if (!message || message == null || message == "") {
                     return false;
                 }
                 
                 if (confirm("!!! Are you sure you want to send this message to all selected users?: " + message)) {
                     $.ajax({
                         type: "POST",
                         url: $("#config").data("base-url") + "dashboard/send-push-to-users-list",
                         data: JSON.stringify({
                             "message": message,
                             "user-ids": users
                         }),
                         dataType: "json",
                         contentType: 'application/json',
                         success: function(response) {
                             alert('Sent!');
                             $('.send-push-to:checked').attr('checked', false);
                         },
                         failure: function(response) {
                             alert('Something went wrong. Push notifications may or may not have been sent. Wait until sure before trying again.');
                             $('.send-push-to:checked').attr('checked', false);
                         }
                     });
                 }
             });
             
         });
        </script>
    </body>
</html>
